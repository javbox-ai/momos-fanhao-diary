<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {# 使用 AI 生成的標題或原始標題 #}
    <title>{{ ai_title if ai_title else video.title }} - {{ 'Momo’s Fanhao Diary' if lang == 'en' else 'Momo 秘密番號小本本' }}</title>
    {# 使用 AI 生成的 SEO 摘要 #}
    <meta name="description" content="{{ seo_summary }}">
    <meta name="robots" content="index, follow">
    {# Open Graph Meta Tags #}
    <meta property="og:title" content="{{ ai_title if ai_title else video.title }}">
    <meta property="og:description" content="{{ seo_summary }}">
    {# Assuming cover_image is an absolute URL or can be made absolute #}
    {# You might need to adjust this logic based on how cover_image is stored/generated #}
    {% set cover_url = video.cover_image if video.cover_image.startswith('http') else ('../../' + video.cover_image.lstrip('/')) %}
    <meta property="og:image" content="{{ cover_url }}">
    {# !! 請確認您的 base_url 或替換為絕對 URL !! #}
    <meta property="og:url" content="{{ base_url | default('https://momo-fanhao-diary.example.com') }}/videos/{{ video.id }}_{{ lang }}.html">
    <meta property="og:type" content="article">
    {# Canonical Link - Adjust base URL as needed #}
    {# !! 請確認您的 base_url 或替換為絕對 URL !! #}
    <link rel="canonical" href="{{ base_url | default('https://momo-fanhao-diary.example.com') }}/videos/{{ video.id }}_{{ lang }}.html">
    {# 引入 Schema.org JSON-LD #}
    {% if schema_json %}
    <script type="application/ld+json">
    {{ schema_json | safe }}
    </script>
    {% endif %}
    <link rel="icon" href="../../static/favicon.png"> {# Favicon relative path from videos/ #}
    <link rel="stylesheet" href="../../static/style.css"> {# CSS relative path from videos/ #}
    <script src="../../static/search.js"></script> {# 添加搜索JS腳本 #}
    <style>
        .cover-placeholder {
            background-color: #eee;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%; /* 或根據設計調整 */
            max-width: 400px; /* 示例最大寬度 */
            height: 600px; /* 示例高度 */
            cursor: pointer;
            border: 1px dashed #ccc;
            margin-bottom: 1em;
            text-align: center;
        }
        .cover-image {
            display: none; /* 初始隱藏 */
            max-width: 100%;
            height: auto;
            margin-bottom: 1em;
        }
        .toggle-cover-button {
            display: inline-block;
            padding: 8px 15px;
            margin-bottom: 1em;
            background-color: #FF69B4; /* 粉色 */
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .toggle-cover-button:hover {
            background-color: #db4b9a;
        }
    </style>
    {% if schema_json %}
    <script type="application/ld+json">
    {{ schema_json | safe }}
    </script>
    {% endif %}
    {# Note: Duplicate favicon link removed during merge, ensure one remains #}
</head>
<body>
    <header>
        <div class="logo">
            <!-- Use breadcrumb home link -->
            <a href="{{ breadcrumb_home_link }}"> 
                {{ 'Momo's Fanhao Diary' if lang == 'en' else 'Momo 秘密番號小本本' }}
            </a>
        </div>
        <nav class="main-nav">
            <!-- Single Search Form -->
            <form id="searchFormHeader" onsubmit="handleSearchSubmit(event); return false;">
                <input type="text" name="q" id="searchInputHeader" placeholder="{{ 'Enter number or actress name' if lang == 'en' else '輸入番號或女優名' }}">
                <button type="submit">{{ 'Search' if lang == 'en' else '搜尋' }}</button>
            </form>
        </nav>
        <div class="language-switcher">
            {# 假設靜態頁面命名規則為 videoId_lang.html #}
            {% set other_lang = 'en' if lang == 'zh' else 'zh' %}
            {# Links are relative within the videos directory #}
            <a href="{{ video.id }}_zh.html" class="{% if lang == 'zh' %}active{% endif %} lang-zh">中文</a> | <a href="{{ video.id }}_en.html" class="{% if lang == 'en' %}active{% endif %} lang-en">English</a>
        </div>
    </header>

    <main>
        {% if video %}
        <article class="video-detail">
            <h1>{{ video.title }} {% if seo_summary %}<span class="seo-summary">{{ seo_summary }}</span>{% endif %}</h1>
            
            <!-- Breadcrumbs -->
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ breadcrumb_home_link }}">{{ 'Homepage' if lang == 'en' else '首頁' }}</a></li>
                    <!-- Add category breadcrumb if available -->
                    {% if category_links %}
                        {% set category_link = category_links[0]['link_zh'] if lang == 'zh' else category_links[0]['link_en'] %}
                        {% set category_name = category_links[0]['name'] %}
                        <li class="breadcrumb-item"><a href="{{ category_link }}">{{ category_name }}</a></li>
                    {% elif video.category %}
                         <li class="breadcrumb-item"><a href="#">{{ video.category }}</a></li> <!-- Fallback if no link -->
                    {% endif %}
                    <li class="breadcrumb-item active" aria-current="page">{{ video.title }}</li>
                </ol>
            </nav>

            <!-- Cover Image with Toggle -->
            {# Generate relative path from videos/ directory to static/ #}
            {% set cover_path_relative = '../' + video.cover_image.lstrip('/') if video.cover_image and not video.cover_image.startswith('http') else video.cover_image %}
            <div class="cover-placeholder" onclick="toggleCoverImage(this, '{{ cover_path_relative }}')">
                {{ 'Click to view cover' if lang == 'en' else '點擊顯示封面' }}
            </div>
            <img src="" alt="{{ video.title }} Cover" class="cover-image" loading="lazy">
            <button class="toggle-cover-button" onclick="toggleCoverImage(document.querySelector('.cover-placeholder'), '{{ cover_path_relative }}')">{{ 'Show/Hide Cover' if lang == 'en' else '顯示/隱藏封面' }}</button>

            <section class="ai-content">
                <h2>{{ "Momo's Thoughts" if lang == 'en' else 'Momo 的心得筆記' }}</h2>
                <p>{{ ai_content | safe }}</p>
            </section>

            <section class="ads-content-top">
                <h3>{{ 'Ad Space (Top)' if lang == 'en' else '廣告位 (頁首/內容前)' }}</h3>
                <p>{{ 'Advertisement' if lang == 'en' else '廣告' }}</p>
            </section>

            <div class="video-meta">
                {% if actress_links %}
                    <span>{{ 'Actress(es)' if lang == 'en' else '女優' }}: 
                    {% for link in actress_links %}
                        <a href="{{ link.link_en if lang == 'en' else link.link_zh }}">{{ link.name }}</a>{% if not loop.last %}, {% endif %}
                    {% endfor %}
                    </span><br>
                {% elif video.actress %} {# Fallback for older data or if links aren't generated #}
                    <span>{{ 'Actress' if lang == 'en' else '女優' }}: {{ video.actress }}</span><br>
                {% endif %}
                {% if video.release_date %}
                <span>{{ 'Release Date' if lang == 'en' else '發行日期' }}: {{ video.release_date if video.release_date else 'N/A' }}</span><br>
                {% endif %}
                {% if lang == 'en' %}
                    {% if genres_en %}
                    <span>{{ 'Genres' if lang == 'en' else '類別' }}: 
                        {% for genre in genres_en %}
                            {# Assuming no specific links for translated genres yet #}
                            <span class="tag">{{ genre }}</span>{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    </span><br>
                    {% endif %}
                {% else %}
                    {# Original logic for Chinese page #}
                    {% if category_links %}
                        <span>{{ 'Genres' if lang == 'en' else '類別' }}: 
                        {% for cat in category_links %}
                            <a href="{{ cat.link_zh if lang == 'zh' else cat.link_en }}" class="tag">{{ cat.name }}</a>{% if not loop.last %}, {% endif %}
                        {% endfor %}
                        </span><br>
                    {% elif video.category %}
                        <span>{{ 'Category' if lang == 'en' else '類別' }}: {{ video.category }}</span><br> {# Fallback #}
                    {% endif %}
                {% endif %}
                {% if video.duration %}
                <span>{{ 'Duration' if lang == 'en' else '片長' }}: {{ video.duration }} {{ 'min' if lang == 'en' else '分鐘' }}</span><br>
                {% endif %}
                {% if lang == 'en' %}
                    {% if tags_en %}
                    <section class="tags">
                        <h3>{{ 'Tags' if lang == 'en' else '標籤' }}</h3>
                        {% for tag in tags_en %}
                            {# Assuming no specific links for translated tags yet #}
                            <span class="tag">{{ tag }}</span>
                        {% endfor %}
                    </section>
                    {% endif %}
                {% else %}
                    {# Original logic for Chinese page #}
                    {% if video.tags %} 
                    <section class="tags">
                        <h3>{{ 'Tags' if lang == 'en' else '標籤' }}</h3>
                        {% for tag in video.tags.split(',') %}
                            {% if tag.strip() %}
                            <span class="tag">{{ tag.strip() }}</span>
                            {% endif %}
                        {% endfor %}
                    </section>
                    {% endif %}
                {% endif %}
            </div>

            <section class="ads-content-middle">
                <h3>{{ 'Ad Space (Middle)' if lang == 'en' else '廣告位 (內容中)' }}</h3>
                <p>{{ 'Advertisement' if lang == 'en' else '廣告' }}</p>
            </section>

            <aside class="floating-nav">
                <h3>{{ 'Extended Search' if lang == 'en' else '延伸搜尋欄' }}</h3>
                {# Removed comment: (可考慮放置在右邊或浮動條上) #}
            </aside>

            <!-- 收藏按鈕 -->
            <button class="favorite-button" id="favoriteBtn" data-video-id="{{ video.id }}">♥ {{ 'Favorite this post' if lang == 'en' else '收藏這一篇' }}</button>

            <section class="ads-content-bottom">
                <h3>{{ 'Ad Space (Bottom)' if lang == 'en' else '廣告位 (頁尾/內容後)' }}</h3>
                <p>{{ 'Advertisement' if lang == 'en' else '廣告' }}</p>
            </section>

            <section class="momo-whisper">
                <h2>{{ "Momo's Whispers" if lang == 'en' else "Momo 的悄悄話" }}</h2>
                <p>{{ "This scene is really something! Makes you think... 😉" if lang == 'en' else "這個畫面真的有點東西！讓人看了都... 😉" }}</p>
            </section>

            <section class="recommendations">
                <h2>{{ 'Recommendations (Optional)' if lang == 'en' else '延伸推薦 (optional)' }}</h2>
                {# Removed comment: 以分類標籤或女優為主... #}
            </section>
        </article>
        {% else %}
        <div class="error-message">
            <h1>{{ 'Error' if lang == 'en' else '錯誤' }}</h1>
            <p>{{ 'Video not found.' if lang == 'en' else '找不到指定的影片。' }}</p>
            <!-- Use breadcrumb home link -->
            <a href="{{ breadcrumb_home_link }}">{{ 'Back to Home' if lang == 'en' else '返回首頁' }}</a>
        </div>
        {% endif %}
        <section class="download-section">
            <h3>{{ 'Download Video' if lang == 'en' else '影片下載' }}</h3>
            {# Link to the static go page, without specific video ID #}
            {# Correct relative path from videos/ to root #}
            <a href="../../go_static.html" class="download-button" target="_blank" rel="noopener noreferrer">
                {{ 'Download Video' if lang == 'en' else '影片下載' }}
            </a>
        </section>
    </main>

    <script>
        function toggleCoverImage(placeholderElement, imageUrl) {
            const imageElement = placeholderElement.nextElementSibling; // Assuming img is right after placeholder
            const buttonElement = imageElement.nextElementSibling; // Assuming button is after img

            if (imageElement.style.display === 'none' || imageElement.style.display === '') {
                // If hidden or unset, show image
                if (imageUrl && imageUrl !== '../../static/placeholder.jpg' && imageUrl !== '../static/placeholder.jpg') {
                    imageElement.src = imageUrl;
                    imageElement.style.display = 'block';
                    placeholderElement.style.display = 'none'; // Hide placeholder
                    buttonElement.textContent = '{{ 'Hide Cover' if lang == 'en' else '隱藏封面' }}';
                } else {
                    // Handle case where image URL is invalid or placeholder
                    placeholderElement.textContent = '{{ 'Cover not available' if lang == 'en' else '封面無法顯示' }}';
                }
            } else {
                // If visible, hide image
                imageElement.style.display = 'none';
                imageElement.src = ''; // Clear src
                placeholderElement.style.display = 'flex'; // Show placeholder again
                buttonElement.textContent = '{{ 'Show Cover' if lang == 'en' else '顯示封面' }}';
            }
        }

        // Search form redirection
        document.getElementById('searchFormHeader').addEventListener('submit', function(event) {
            event.preventDefault();
            const query = document.getElementById('searchInputHeader').value;
            // Redirect to a general search page (e.g., AvHub or a static search result page)
            // Adjust the URL as needed
            window.location.href = `https://javdb.com/search?q=${encodeURIComponent(query)}&f=all`; // Example redirect
        });

        // Favorite button functionality (basic example, needs backend/local storage)
        const favoriteBtn = document.getElementById('favoriteBtn');
        if (favoriteBtn) {
            const videoId = favoriteBtn.getAttribute('data-video-id');
            // Check local storage if this video is favorited
            const favorites = JSON.parse(localStorage.getItem('favoriteVideos') || '{}');
            if (favorites[videoId]) {
                favoriteBtn.textContent = '♥ {{ 'Favorited' if lang == 'en' else '已收藏' }}';
                favoriteBtn.classList.add('favorited');
            }

            favoriteBtn.addEventListener('click', function() {
                const currentFavorites = JSON.parse(localStorage.getItem('favoriteVideos') || '{}');
                if (currentFavorites[videoId]) {
                    delete currentFavorites[videoId];
                    favoriteBtn.textContent = '♥ {{ 'Favorite this post' if lang == 'en' else '收藏這一篇' }}';
                    favoriteBtn.classList.remove('favorited');
                } else {
                    currentFavorites[videoId] = true;
                    favoriteBtn.textContent = '♥ {{ 'Favorited' if lang == 'en' else '已收藏' }}';
                    favoriteBtn.classList.add('favorited');
                }
                localStorage.setItem('favoriteVideos', JSON.stringify(currentFavorites));
            });
        }
    </script>

    <section class="disclaimer">
        <h2>{{ 'Disclaimer' if lang == 'en' else '免責聲明' }}</h2>
        {% if lang == 'zh' %}
        <p>本網站僅作為AV心得分享與資源檢索工具，所有內容僅供學術交流與個人參考，並不存儲、製作、傳播任何非法或受版權保護的影音資源。</p>
        <p>用戶應遵守當地法律法規，任何因使用本網站導致的法律責任由用戶自行承擔。</p>
        <p>若有任何侵權或不當內容，請聯繫我們，我們將及時處理。</p>
        {% else %}
        <p>This website is for sharing AV reviews and providing resource search tools only. All content is for academic exchange and personal reference.</p>
        <p>We do not store, produce, or distribute any illegal or copyrighted audiovisual materials.</p>
        <p>Users must comply with local laws and regulations. Any legal responsibility arising from the use of this website shall be borne by the user.</p>
        <p>If there is any infringement or inappropriate content, please contact us and we will handle it promptly.</p>
        {% endif %}
    </section>

    <footer>
        <section class="ads-footer">
            <h3>{{ 'Ad Space (Footer)' if lang == 'en' else '廣告位 (頁尾)' }}</h3>
            <p>{{ 'Advertisement' if lang == 'en' else '廣告' }}</p>
        </section>
        <p>&copy; {{ current_year }} {{ 'AV Review Sharing' if lang == 'en' else 'AV心得分享' }}</p>
    </footer>

    <script>
        // 封面圖顯示/隱藏邏輯
        const toggleBtn = document.getElementById('toggleCoverBtn');
        const coverImg = document.getElementById('coverImage');
        const showText = "{{ 'Show Cover' if lang == 'en' else '顯示封面' }}";
        const hideText = "{{ 'Hide Cover' if lang == 'en' else '隱藏封面' }}";

        if (toggleBtn && coverImg) {
            toggleBtn.addEventListener('click', () => {
                if (coverImg.style.display === 'none' || coverImg.style.display === '') {
                    coverImg.style.display = 'block';
                    toggleBtn.textContent = hideText;
                } else {
                    coverImg.style.display = 'none';
                    toggleBtn.textContent = showText;
                }
            });
        }

        // 頁首搜尋表單提交邏輯
        const searchFormHeader = document.getElementById('searchFormHeader');
        const searchInputHeader = document.getElementById('searchInputHeader');
        if (searchFormHeader && searchInputHeader) {
            searchFormHeader.addEventListener('submit', function(event) {
                event.preventDefault(); // 防止表單預設提交
                const query = searchInputHeader.value.trim();
                if (query) {
                    // 將搜尋導向 AvHub，使用 go_static.html 進行跳轉
                    const searchUrl = `https://avhub.pages.dev/search/${encodeURIComponent(query)}`;
                    // 相對路徑到 go_static.html
                    window.open(`../../go_static.html?target=${encodeURIComponent(searchUrl)}`, '_blank'); 
                }
            });
        }

        // 收藏按鈕邏輯 (示例，實際功能需後端支持)
        const favoriteBtn = document.getElementById('favoriteBtn');
        if (favoriteBtn) {
            favoriteBtn.addEventListener('click', () => {
                const videoId = favoriteBtn.getAttribute('data-video-id');
                // 在靜態頁面中，收藏通常需要與伺服器交互或使用 localStorage
                // 這裡只是一個簡單的提示
                alert(`{{ 'Favorite status toggled for video:' if lang == 'en' else '已切換影片收藏狀態：' }} ${videoId} (靜態頁面功能有限)`);
                // 可以添加/移除一個 class 來改變按鈕樣式
                favoriteBtn.classList.toggle('favorited'); 
            });
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {# ä½¿ç”¨ AI ç”Ÿæˆçš„æ¨™é¡Œæˆ–åŸå§‹æ¨™é¡Œ #}
    <title>{{ ai_title if ai_title else video.title }} - {{ 'Momoâ€™s Fanhao Diary' if lang == 'en' else 'Momo ç§˜å¯†ç•ªè™Ÿå°æœ¬æœ¬' }}</title>
    {# ä½¿ç”¨ AI ç”Ÿæˆçš„ SEO æ‘˜è¦ #}
    <meta name="description" content="{{ seo_summary }}">
    <meta name="robots" content="index, follow">
    {# Open Graph Meta Tags #}
    <meta property="og:title" content="{{ ai_title if ai_title else video.title }}">
    <meta property="og:description" content="{{ seo_summary }}">
    {# Assuming cover_image is an absolute URL or can be made absolute #}
    {# You might need to adjust this logic based on how cover_image is stored/generated #}
    {% set cover_url = video.cover_image if video.cover_image.startswith('http') else ('../../' + video.cover_image.lstrip('/')) %}
    <meta property="og:image" content="{{ cover_url }}">
    {# !! è«‹ç¢ºèªæ‚¨çš„ base_url æˆ–æ›¿æ›ç‚ºçµ•å° URL !! #}
    <meta property="og:url" content="{{ base_url | default('https://momo-fanhao-diary.example.com') }}/videos/{{ video.id }}_{{ lang }}.html">
    <meta property="og:type" content="article">
    {# Canonical Link - Adjust base URL as needed #}
    {# !! è«‹ç¢ºèªæ‚¨çš„ base_url æˆ–æ›¿æ›ç‚ºçµ•å° URL !! #}
    <link rel="canonical" href="{{ base_url | default('https://momo-fanhao-diary.example.com') }}/videos/{{ video.id }}_{{ lang }}.html">
    {# å¼•å…¥ Schema.org JSON-LD #}
    {% if schema_json %}
    <script type="application/ld+json">
    {{ schema_json | safe }}
    </script>
    {% endif %}
    <link rel="icon" href="../../static/favicon.png"> {# Favicon relative path from videos/ #}
    <link rel="stylesheet" href="../../static/style.css"> {# CSS relative path from videos/ #}
    <script src="../../static/search.js"></script> {# æ·»åŠ æœç´¢JSè…³æœ¬ #}
    <style>
        .cover-placeholder {
            background-color: #eee;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%; /* æˆ–æ ¹æ“šè¨­è¨ˆèª¿æ•´ */
            max-width: 400px; /* ç¤ºä¾‹æœ€å¤§å¯¬åº¦ */
            height: 600px; /* ç¤ºä¾‹é«˜åº¦ */
            cursor: pointer;
            border: 1px dashed #ccc;
            margin-bottom: 1em;
            text-align: center;
        }
        .cover-image {
            display: none; /* åˆå§‹éš±è— */
            max-width: 100%;
            height: auto;
            margin-bottom: 1em;
        }
        .toggle-cover-button {
            display: inline-block;
            padding: 8px 15px;
            margin-bottom: 1em;
            background-color: #FF69B4; /* ç²‰è‰² */
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .toggle-cover-button:hover {
            background-color: #db4b9a;
        }
    </style>
    {% if schema_json %}
    <script type="application/ld+json">
    {{ schema_json | safe }}
    </script>
    {% endif %}
    {# Note: Duplicate favicon link removed during merge, ensure one remains #}
</head>
<body>
    <header>
        <div class="logo">
            <!-- Use breadcrumb home link -->
            <a href="{{ breadcrumb_home_link }}"> 
                {{ 'Momo's Fanhao Diary' if lang == 'en' else 'Momo ç§˜å¯†ç•ªè™Ÿå°æœ¬æœ¬' }}
            </a>
        </div>
        <nav class="main-nav">
            <!-- Single Search Form -->
            <form id="searchFormHeader" onsubmit="handleSearchSubmit(event); return false;">
                <input type="text" name="q" id="searchInputHeader" placeholder="{{ 'Enter number or actress name' if lang == 'en' else 'è¼¸å…¥ç•ªè™Ÿæˆ–å¥³å„ªå' }}">
                <button type="submit">{{ 'Search' if lang == 'en' else 'æœå°‹' }}</button>
            </form>
        </nav>
        <div class="language-switcher">
            {# å‡è¨­éœæ…‹é é¢å‘½åè¦å‰‡ç‚º videoId_lang.html #}
            {% set other_lang = 'en' if lang == 'zh' else 'zh' %}
            {# Links are relative within the videos directory #}
            <a href="{{ video.id }}_zh.html" class="{% if lang == 'zh' %}active{% endif %} lang-zh">ä¸­æ–‡</a> | <a href="{{ video.id }}_en.html" class="{% if lang == 'en' %}active{% endif %} lang-en">English</a>
        </div>
    </header>

    <main>
        {% if video %}
        <article class="video-detail">
            <h1>{{ video.title }} {% if seo_summary %}<span class="seo-summary">{{ seo_summary }}</span>{% endif %}</h1>
            
            <!-- Breadcrumbs -->
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ breadcrumb_home_link }}">{{ 'Homepage' if lang == 'en' else 'é¦–é ' }}</a></li>
                    <!-- Add category breadcrumb if available -->
                    {% if category_links %}
                        {% set category_link = category_links[0]['link_zh'] if lang == 'zh' else category_links[0]['link_en'] %}
                        {% set category_name = category_links[0]['name'] %}
                        <li class="breadcrumb-item"><a href="{{ category_link }}">{{ category_name }}</a></li>
                    {% elif video.category %}
                         <li class="breadcrumb-item"><a href="#">{{ video.category }}</a></li> <!-- Fallback if no link -->
                    {% endif %}
                    <li class="breadcrumb-item active" aria-current="page">{{ video.title }}</li>
                </ol>
            </nav>

            <!-- Cover Image with Toggle -->
            {# Generate relative path from videos/ directory to static/ #}
            {% set cover_path_relative = '../' + video.cover_image.lstrip('/') if video.cover_image and not video.cover_image.startswith('http') else video.cover_image %}
            <div class="cover-placeholder" onclick="toggleCoverImage(this, '{{ cover_path_relative }}')">
                {{ 'Click to view cover' if lang == 'en' else 'é»æ“Šé¡¯ç¤ºå°é¢' }}
            </div>
            <img src="" alt="{{ video.title }} Cover" class="cover-image" loading="lazy">
            <button class="toggle-cover-button" onclick="toggleCoverImage(document.querySelector('.cover-placeholder'), '{{ cover_path_relative }}')">{{ 'Show/Hide Cover' if lang == 'en' else 'é¡¯ç¤º/éš±è—å°é¢' }}</button>

            <section class="ai-content">
                <h2>{{ "Momo's Thoughts" if lang == 'en' else 'Momo çš„å¿ƒå¾—ç­†è¨˜' }}</h2>
                <p>{{ ai_content | safe }}</p>
            </section>

            <section class="ads-content-top">
                <h3>{{ 'Ad Space (Top)' if lang == 'en' else 'å»£å‘Šä½ (é é¦–/å…§å®¹å‰)' }}</h3>
                <p>{{ 'Advertisement' if lang == 'en' else 'å»£å‘Š' }}</p>
            </section>

            <div class="video-meta">
                {% if actress_links %}
                    <span>{{ 'Actress(es)' if lang == 'en' else 'å¥³å„ª' }}: 
                    {% for link in actress_links %}
                        <a href="{{ link.link_en if lang == 'en' else link.link_zh }}">{{ link.name }}</a>{% if not loop.last %}, {% endif %}
                    {% endfor %}
                    </span><br>
                {% elif video.actress %} {# Fallback for older data or if links aren't generated #}
                    <span>{{ 'Actress' if lang == 'en' else 'å¥³å„ª' }}: {{ video.actress }}</span><br>
                {% endif %}
                {% if video.release_date %}
                <span>{{ 'Release Date' if lang == 'en' else 'ç™¼è¡Œæ—¥æœŸ' }}: {{ video.release_date if video.release_date else 'N/A' }}</span><br>
                {% endif %}
                {% if lang == 'en' %}
                    {% if genres_en %}
                    <span>{{ 'Genres' if lang == 'en' else 'é¡åˆ¥' }}: 
                        {% for genre in genres_en %}
                            {# Assuming no specific links for translated genres yet #}
                            <span class="tag">{{ genre }}</span>{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    </span><br>
                    {% endif %}
                {% else %}
                    {# Original logic for Chinese page #}
                    {% if category_links %}
                        <span>{{ 'Genres' if lang == 'en' else 'é¡åˆ¥' }}: 
                        {% for cat in category_links %}
                            <a href="{{ cat.link_zh if lang == 'zh' else cat.link_en }}" class="tag">{{ cat.name }}</a>{% if not loop.last %}, {% endif %}
                        {% endfor %}
                        </span><br>
                    {% elif video.category %}
                        <span>{{ 'Category' if lang == 'en' else 'é¡åˆ¥' }}: {{ video.category }}</span><br> {# Fallback #}
                    {% endif %}
                {% endif %}
                {% if video.duration %}
                <span>{{ 'Duration' if lang == 'en' else 'ç‰‡é•·' }}: {{ video.duration }} {{ 'min' if lang == 'en' else 'åˆ†é˜' }}</span><br>
                {% endif %}
                {% if lang == 'en' %}
                    {% if tags_en %}
                    <section class="tags">
                        <h3>{{ 'Tags' if lang == 'en' else 'æ¨™ç±¤' }}</h3>
                        {% for tag in tags_en %}
                            {# Assuming no specific links for translated tags yet #}
                            <span class="tag">{{ tag }}</span>
                        {% endfor %}
                    </section>
                    {% endif %}
                {% else %}
                    {# Original logic for Chinese page #}
                    {% if video.tags %} 
                    <section class="tags">
                        <h3>{{ 'Tags' if lang == 'en' else 'æ¨™ç±¤' }}</h3>
                        {% for tag in video.tags.split(',') %}
                            {% if tag.strip() %}
                            <span class="tag">{{ tag.strip() }}</span>
                            {% endif %}
                        {% endfor %}
                    </section>
                    {% endif %}
                {% endif %}
            </div>

            <section class="ads-content-middle">
                <h3>{{ 'Ad Space (Middle)' if lang == 'en' else 'å»£å‘Šä½ (å…§å®¹ä¸­)' }}</h3>
                <p>{{ 'Advertisement' if lang == 'en' else 'å»£å‘Š' }}</p>
            </section>

            <aside class="floating-nav">
                <h3>{{ 'Extended Search' if lang == 'en' else 'å»¶ä¼¸æœå°‹æ¬„' }}</h3>
                {# Removed comment: (å¯è€ƒæ…®æ”¾ç½®åœ¨å³é‚Šæˆ–æµ®å‹•æ¢ä¸Š) #}
            </aside>

            <!-- æ”¶è—æŒ‰éˆ• -->
            <button class="favorite-button" id="favoriteBtn" data-video-id="{{ video.id }}">â™¥ {{ 'Favorite this post' if lang == 'en' else 'æ”¶è—é€™ä¸€ç¯‡' }}</button>

            <section class="ads-content-bottom">
                <h3>{{ 'Ad Space (Bottom)' if lang == 'en' else 'å»£å‘Šä½ (é å°¾/å…§å®¹å¾Œ)' }}</h3>
                <p>{{ 'Advertisement' if lang == 'en' else 'å»£å‘Š' }}</p>
            </section>

            <section class="momo-whisper">
                <h2>{{ "Momo's Whispers" if lang == 'en' else "Momo çš„æ‚„æ‚„è©±" }}</h2>
                <p>{{ "This scene is really something! Makes you think... ğŸ˜‰" if lang == 'en' else "é€™å€‹ç•«é¢çœŸçš„æœ‰é»æ±è¥¿ï¼è®“äººçœ‹äº†éƒ½... ğŸ˜‰" }}</p>
            </section>

            <section class="recommendations">
                <h2>{{ 'Recommendations (Optional)' if lang == 'en' else 'å»¶ä¼¸æ¨è–¦ (optional)' }}</h2>
                {# Removed comment: ä»¥åˆ†é¡æ¨™ç±¤æˆ–å¥³å„ªç‚ºä¸»... #}
            </section>
        </article>
        {% else %}
        <div class="error-message">
            <h1>{{ 'Error' if lang == 'en' else 'éŒ¯èª¤' }}</h1>
            <p>{{ 'Video not found.' if lang == 'en' else 'æ‰¾ä¸åˆ°æŒ‡å®šçš„å½±ç‰‡ã€‚' }}</p>
            <!-- Use breadcrumb home link -->
            <a href="{{ breadcrumb_home_link }}">{{ 'Back to Home' if lang == 'en' else 'è¿”å›é¦–é ' }}</a>
        </div>
        {% endif %}
        <section class="download-section">
            <h3>{{ 'Download Video' if lang == 'en' else 'å½±ç‰‡ä¸‹è¼‰' }}</h3>
            {# Link to the static go page, without specific video ID #}
            {# Correct relative path from videos/ to root #}
            <a href="../../go_static.html" class="download-button" target="_blank" rel="noopener noreferrer">
                {{ 'Download Video' if lang == 'en' else 'å½±ç‰‡ä¸‹è¼‰' }}
            </a>
        </section>
    </main>

    <script>
        function toggleCoverImage(placeholderElement, imageUrl) {
            const imageElement = placeholderElement.nextElementSibling; // Assuming img is right after placeholder
            const buttonElement = imageElement.nextElementSibling; // Assuming button is after img

            if (imageElement.style.display === 'none' || imageElement.style.display === '') {
                // If hidden or unset, show image
                if (imageUrl && imageUrl !== '../../static/placeholder.jpg' && imageUrl !== '../static/placeholder.jpg') {
                    imageElement.src = imageUrl;
                    imageElement.style.display = 'block';
                    placeholderElement.style.display = 'none'; // Hide placeholder
                    buttonElement.textContent = '{{ 'Hide Cover' if lang == 'en' else 'éš±è—å°é¢' }}';
                } else {
                    // Handle case where image URL is invalid or placeholder
                    placeholderElement.textContent = '{{ 'Cover not available' if lang == 'en' else 'å°é¢ç„¡æ³•é¡¯ç¤º' }}';
                }
            } else {
                // If visible, hide image
                imageElement.style.display = 'none';
                imageElement.src = ''; // Clear src
                placeholderElement.style.display = 'flex'; // Show placeholder again
                buttonElement.textContent = '{{ 'Show Cover' if lang == 'en' else 'é¡¯ç¤ºå°é¢' }}';
            }
        }

        // Search form redirection
        document.getElementById('searchFormHeader').addEventListener('submit', function(event) {
            event.preventDefault();
            const query = document.getElementById('searchInputHeader').value;
            // Redirect to a general search page (e.g., AvHub or a static search result page)
            // Adjust the URL as needed
            window.location.href = `https://javdb.com/search?q=${encodeURIComponent(query)}&f=all`; // Example redirect
        });

        // Favorite button functionality (basic example, needs backend/local storage)
        const favoriteBtn = document.getElementById('favoriteBtn');
        if (favoriteBtn) {
            const videoId = favoriteBtn.getAttribute('data-video-id');
            // Check local storage if this video is favorited
            const favorites = JSON.parse(localStorage.getItem('favoriteVideos') || '{}');
            if (favorites[videoId]) {
                favoriteBtn.textContent = 'â™¥ {{ 'Favorited' if lang == 'en' else 'å·²æ”¶è—' }}';
                favoriteBtn.classList.add('favorited');
            }

            favoriteBtn.addEventListener('click', function() {
                const currentFavorites = JSON.parse(localStorage.getItem('favoriteVideos') || '{}');
                if (currentFavorites[videoId]) {
                    delete currentFavorites[videoId];
                    favoriteBtn.textContent = 'â™¥ {{ 'Favorite this post' if lang == 'en' else 'æ”¶è—é€™ä¸€ç¯‡' }}';
                    favoriteBtn.classList.remove('favorited');
                } else {
                    currentFavorites[videoId] = true;
                    favoriteBtn.textContent = 'â™¥ {{ 'Favorited' if lang == 'en' else 'å·²æ”¶è—' }}';
                    favoriteBtn.classList.add('favorited');
                }
                localStorage.setItem('favoriteVideos', JSON.stringify(currentFavorites));
            });
        }
    </script>

    <section class="disclaimer">
        <h2>{{ 'Disclaimer' if lang == 'en' else 'å…è²¬è²æ˜' }}</h2>
        {% if lang == 'zh' %}
        <p>æœ¬ç¶²ç«™åƒ…ä½œç‚ºAVå¿ƒå¾—åˆ†äº«èˆ‡è³‡æºæª¢ç´¢å·¥å…·ï¼Œæ‰€æœ‰å…§å®¹åƒ…ä¾›å­¸è¡“äº¤æµèˆ‡å€‹äººåƒè€ƒï¼Œä¸¦ä¸å­˜å„²ã€è£½ä½œã€å‚³æ’­ä»»ä½•éæ³•æˆ–å—ç‰ˆæ¬Šä¿è­·çš„å½±éŸ³è³‡æºã€‚</p>
        <p>ç”¨æˆ¶æ‡‰éµå®ˆç•¶åœ°æ³•å¾‹æ³•è¦ï¼Œä»»ä½•å› ä½¿ç”¨æœ¬ç¶²ç«™å°è‡´çš„æ³•å¾‹è²¬ä»»ç”±ç”¨æˆ¶è‡ªè¡Œæ‰¿æ“”ã€‚</p>
        <p>è‹¥æœ‰ä»»ä½•ä¾µæ¬Šæˆ–ä¸ç•¶å…§å®¹ï¼Œè«‹è¯ç¹«æˆ‘å€‘ï¼Œæˆ‘å€‘å°‡åŠæ™‚è™•ç†ã€‚</p>
        {% else %}
        <p>This website is for sharing AV reviews and providing resource search tools only. All content is for academic exchange and personal reference.</p>
        <p>We do not store, produce, or distribute any illegal or copyrighted audiovisual materials.</p>
        <p>Users must comply with local laws and regulations. Any legal responsibility arising from the use of this website shall be borne by the user.</p>
        <p>If there is any infringement or inappropriate content, please contact us and we will handle it promptly.</p>
        {% endif %}
    </section>

    <footer>
        <section class="ads-footer">
            <h3>{{ 'Ad Space (Footer)' if lang == 'en' else 'å»£å‘Šä½ (é å°¾)' }}</h3>
            <p>{{ 'Advertisement' if lang == 'en' else 'å»£å‘Š' }}</p>
        </section>
        <p>&copy; {{ current_year }} {{ 'AV Review Sharing' if lang == 'en' else 'AVå¿ƒå¾—åˆ†äº«' }}</p>
    </footer>

    <script>
        // å°é¢åœ–é¡¯ç¤º/éš±è—é‚è¼¯
        const toggleBtn = document.getElementById('toggleCoverBtn');
        const coverImg = document.getElementById('coverImage');
        const showText = "{{ 'Show Cover' if lang == 'en' else 'é¡¯ç¤ºå°é¢' }}";
        const hideText = "{{ 'Hide Cover' if lang == 'en' else 'éš±è—å°é¢' }}";

        if (toggleBtn && coverImg) {
            toggleBtn.addEventListener('click', () => {
                if (coverImg.style.display === 'none' || coverImg.style.display === '') {
                    coverImg.style.display = 'block';
                    toggleBtn.textContent = hideText;
                } else {
                    coverImg.style.display = 'none';
                    toggleBtn.textContent = showText;
                }
            });
        }

        // é é¦–æœå°‹è¡¨å–®æäº¤é‚è¼¯
        const searchFormHeader = document.getElementById('searchFormHeader');
        const searchInputHeader = document.getElementById('searchInputHeader');
        if (searchFormHeader && searchInputHeader) {
            searchFormHeader.addEventListener('submit', function(event) {
                event.preventDefault(); // é˜²æ­¢è¡¨å–®é è¨­æäº¤
                const query = searchInputHeader.value.trim();
                if (query) {
                    // å°‡æœå°‹å°å‘ AvHubï¼Œä½¿ç”¨ go_static.html é€²è¡Œè·³è½‰
                    const searchUrl = `https://avhub.pages.dev/search/${encodeURIComponent(query)}`;
                    // ç›¸å°è·¯å¾‘åˆ° go_static.html
                    window.open(`../../go_static.html?target=${encodeURIComponent(searchUrl)}`, '_blank'); 
                }
            });
        }

        // æ”¶è—æŒ‰éˆ•é‚è¼¯ (ç¤ºä¾‹ï¼Œå¯¦éš›åŠŸèƒ½éœ€å¾Œç«¯æ”¯æŒ)
        const favoriteBtn = document.getElementById('favoriteBtn');
        if (favoriteBtn) {
            favoriteBtn.addEventListener('click', () => {
                const videoId = favoriteBtn.getAttribute('data-video-id');
                // åœ¨éœæ…‹é é¢ä¸­ï¼Œæ”¶è—é€šå¸¸éœ€è¦èˆ‡ä¼ºæœå™¨äº¤äº’æˆ–ä½¿ç”¨ localStorage
                // é€™è£¡åªæ˜¯ä¸€å€‹ç°¡å–®çš„æç¤º
                alert(`{{ 'Favorite status toggled for video:' if lang == 'en' else 'å·²åˆ‡æ›å½±ç‰‡æ”¶è—ç‹€æ…‹ï¼š' }} ${videoId} (éœæ…‹é é¢åŠŸèƒ½æœ‰é™)`);
                // å¯ä»¥æ·»åŠ /ç§»é™¤ä¸€å€‹ class ä¾†æ”¹è®ŠæŒ‰éˆ•æ¨£å¼
                favoriteBtn.classList.toggle('favorited'); 
            });
        }
    </script>
</body>
</html>